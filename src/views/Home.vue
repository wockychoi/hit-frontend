<template>
  <div class="table-container">
    <h2>📦 주문내역 관리</h2>
    <p>Total {{ filteredOrders.length }}건</p>

    <!-- 검색창 -->
    <div class="search-bar">
      <select v-model="searchField">
        <option value="shippingDate">출고일자</option>
        <option value="productName">상품명</option>
        <option value="ordererName">주문자</option>
        <option value="recPerson">수령자</option>
        <option value="orderSeq">주문번호</option>
        <option value="orderDate">주문일자</option>
      </select>
      <input
        v-model="searchQuery"
        type="text"
        placeholder="검색어를 입력하세요"
      />
      <button @click="clearSearch">❌ 초기화</button>
    </div>

    <!-- 액션 버튼 -->
    <div class="global-actions">
      <button class="btn-add" @click="addOrder">➕ 추가</button>
      <button class="btn-copy" @click="copySelected">📑 복사</button>
      <button class="btn-save" @click="saveSelected">💾 선택 저장</button>
      <button class="btn-update" @click="updateSelected">✏️ 선택 수정</button>
      <button class="btn-delete" @click="deleteSelected">🗑️ 선택 삭제</button>
    </div>

    <!-- 테이블 -->
    <div class="table-wrapper">
      <table class="order-table">
        <thead>
          <tr>
            <th>선택</th>
            <th>출고일자</th>
            <th>택배사</th>
            <th>송장번호</th>
            <th>주문일자</th>
            <th>구분</th>
            <th>거래처명</th>
            <th>주문자</th>
            <th>수령자</th>
            <th>상품고유번호</th>
            <th>휴대전화</th>
            <th>상품명</th>
            <th>결제수단</th>
            <th>우편번호</th>
            <th>수량</th>
            <th>단가</th>
            <th>금액</th>
            <th>택배비</th>
            <th>총결제금액</th>
            <th>배송메세지</th>
            <th>관리자메모</th>
            <th>배송지</th>
            <th>작업</th>
          </tr>
        </thead>
        <tbody>
          <tr
            v-for="(order, localIndex) in paginatedOrders"
            :key="order.orderSeq || getGlobalIndex(localIndex)"
          >
            <!-- 체크박스 -->
            <td>
              <input
                type="checkbox"
                v-model="selectedOrders"
                :value="getGlobalIndex(localIndex)"
              />
            </td>

            <!-- 수정 모드 적용 -->
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.shippingDate }}</span>
              <input v-else v-model="order.shippingDate" type="date" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.courier }}</span>
              <input v-else v-model="order.courier" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.trackingNo }}</span>
              <input v-else v-model="order.trackingNo" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.orderDate }}</span>
              <input v-else v-model="order.orderDate" type="date" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.orderType }}</span>
              <input v-else v-model="order.orderType" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.customerName }}</span>
              <input v-else v-model="order.customerName" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.ordererName }}</span>
              <input v-else v-model="order.ordererName" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.recPerson }}</span>
              <input v-else v-model="order.recPerson" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.productCode }}</span>
              <input v-else v-model="order.productCode" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.phoneNumber }}</span>
              <input v-else v-model="order.phoneNumber" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.productName }}</span>
              <input v-else v-model="order.productName" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.paymentMethod }}</span>
              <input v-else v-model="order.paymentMethod" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.postalCode }}</span>
              <input v-else v-model="order.postalCode" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.quantity }}</span>
              <input v-else v-model.number="order.quantity" type="number" class="edit-input" />
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.unitPrice }}</span>
              <input v-else v-model.number="order.unitPrice" type="number" class="edit-input" />
            </td>
            <td>{{ order.quantity * order.unitPrice }}</td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.shippingFee }}</span>
              <input v-else v-model.number="order.shippingFee" type="number" class="edit-input" />
            </td>
            <td>{{ (order.quantity * order.unitPrice) + (order.shippingFee || 0) }}</td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.deliveryMessage }}</span>
              <textarea v-else v-model="order.deliveryMessage" class="edit-textarea"></textarea>
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.adminMemo }}</span>
              <textarea v-else v-model="order.adminMemo" class="edit-textarea"></textarea>
            </td>
            <td>
              <span v-if="editRow !== order.orderSeq">{{ order.deliveryAddress }}</span>
              <textarea v-else v-model="order.deliveryAddress" class="edit-textarea"></textarea>
            </td>

            <!-- 작업 버튼 -->
            <td>
              <button v-if="editRow !== order.orderSeq" class="btn-update" @click="editRow = order.orderSeq">✏️ 수정</button>
              <button v-else class="btn-save" @click="saveRow(order)">💾 저장</button>
              <button v-if="editRow === order.orderSeq" class="btn-delete" @click="cancelEdit">취소</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 총 결제 금액 -->
    <div class="total-amount">
      총 결제 금액: {{ totalAmount.toLocaleString() }} 원
    </div>

    <!-- 페이징 -->
    <div class="pagination">
      <button @click="prevPage" :disabled="currentPage === 1">이전</button>
      <span>{{ currentPage }} / {{ totalPages }}</span>
      <button @click="nextPage" :disabled="currentPage >= totalPages">다음</button>
    </div>
  </div>
</template>

<script>
import axios from "axios";

export default {
  data() {
    return {
      currentPage: 1,
      pageSize: 10,
      selectedOrders: [],
      orders: [],
      searchQuery: "",
      searchField: "productName",
      editRow: null, // 수정 중인 행
    };
  },
  computed: {
    filteredOrders() {
      if (!this.searchQuery) return this.orders;
      return this.orders.filter((order) => {
        const fieldValue = order[this.searchField];
        if (!fieldValue) return false;
        return String(fieldValue).toLowerCase().includes(this.searchQuery.toLowerCase());
      });
    },
    totalPages() {
      return Math.max(1, Math.ceil(this.filteredOrders.length / this.pageSize));
    },
    paginatedOrders() {
      const start = (this.currentPage - 1) * this.pageSize;
      return this.filteredOrders.slice(start, start + this.pageSize);
    },
    totalAmount() {
      return this.filteredOrders.reduce(
        (sum, o) => sum + (o.quantity * o.unitPrice) + (o.shippingFee || 0),
        0
      );
    },
  },
  methods: {
    async fetchOrders() {
      try {
        const res = await axios.get("http://localhost:8080/admin/api/order/list");
        this.orders = res.data;
      } catch (err) {
        console.error(err);
        alert("주문 목록을 불러오는 중 오류 발생");
      }
    },
    clearSearch() {
      this.searchQuery = "";
      this.currentPage = 1;
    },
    getGlobalIndex(localIndex) {
      return localIndex + (this.currentPage - 1) * this.pageSize;
    },
    prevPage() {
      if (this.currentPage > 1) this.currentPage--;
    },
    nextPage() {
      if (this.currentPage < this.totalPages) this.currentPage++;
    },
    getSelectedOrders() {
      return this.selectedOrders.map((i) => this.filteredOrders[i]);
    },
    // ✅ 추가 버튼 → 새 행 추가 + 즉시 편집 가능
    addOrder() {
      const newOrder = {
        orderSeq: Date.now(), // 임시 키
        shippingDate: "",
        courier: "",
        trackingNo: "",
        orderDate: "",
        orderType: "",
        customerName: "",
        ordererName: "",
        recPerson: "",
        productCode: "",
        phoneNumber: "",
        productName: "",
        paymentMethod: "",
        postalCode: "",
        quantity: 1,
        unitPrice: 0,
        shippingFee: 0,
        deliveryMessage: "",
        adminMemo: "",
        deliveryAddress: "",
      };
      this.orders.unshift(newOrder);
      this.editRow = newOrder.orderSeq; // 바로 수정 모드
    },
    // ✅ 복사 버튼 → 새 행 추가 + 즉시 편집 가능
    copySelected() {
      const selected = this.getSelectedOrders();
      selected.forEach((o) => {
        const copy = { ...o, orderSeq: Date.now() + Math.random() };
        this.orders.unshift(copy);
        this.editRow = copy.orderSeq; // 복사 후 즉시 수정 가능
      });
    },
    async saveSelected() {
      const selected = this.getSelectedOrders();
      if (!selected.length) {
        alert("선택된 주문이 없습니다.");
        return;
      }
      try {
        await axios.post("http://localhost:8080/admin/api/order/save", selected);
        alert("선택 주문 저장 완료");
        this.fetchOrders();
      } catch (err) {
        console.error(err);
        alert("저장 중 오류 발생");
      }
    },
    async updateSelected() {
      const selected = this.getSelectedOrders();
      if (!selected.length) {
        alert("선택된 주문이 없습니다.");
        return;
      }
      try {
        await axios.post("http://localhost:8080/admin/api/order/update", selected);
        alert("선택 주문 수정 완료");
        this.fetchOrders();
      } catch (err) {
        console.error(err);
        alert("수정 중 오류 발생");
      }
    },
    async deleteSelected() {
      const selected = this.getSelectedOrders();
      if (!selected.length) {
        alert("선택된 주문이 없습니다.");
        return;
      }
      if (!confirm("정말 삭제하시겠습니까?")) return;

      // ✅ orderSeq만 추출해서 보내기
      const orderSeqList = selected.map((o) => o.orderSeq);

      try {
        await axios.post("http://localhost:8080/admin/api/order/delete", orderSeqList);
        alert("선택 주문 삭제 완료");
        this.fetchOrders();
        this.selectedOrders = [];
      } catch (err) {
        console.error(err);
        alert("삭제 중 오류 발생");
      }
    },
    async saveRow(order) {
      try {
        await axios.post("http://localhost:8080/admin/api/order/update", [order]);
        alert("주문이 수정되었습니다.");
        this.editRow = null;
        this.fetchOrders();
      } catch (err) {
        console.error(err);
        alert("수정 중 오류 발생");
      }
    },
    cancelEdit() {
      this.editRow = null;
      this.fetchOrders();
    },
  },
  mounted() {
    this.fetchOrders();
  },
};
</script>

<style scoped>
.table-container {
  width: 100%;
  margin: 10px auto;
  padding: 5px;
  background: #fff;
  border-radius: 8px;
  font-size: 11px;
}
.table-wrapper {
  width: 100%;
  overflow-x: auto;
}
.order-table {
  width: 100%;
  border-collapse: collapse;
  text-align: center;
  font-size: 11px;
}
.order-table th {
  background: #222;
  color: #fff;
  padding: 4px;
}
.order-table td {
  border: 1px solid #e6e6e6;
  padding: 3px;
}
.edit-input {
  width: 90%;
  font-size: 11px;
  padding: 2px;
}
.edit-textarea {
  width: 90%;
  font-size: 11px;
  padding: 2px;
  height: 30px;
}
.global-actions {
  margin-bottom: 8px;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.global-actions button {
  padding: 4px 6px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 11px;
}
.btn-add { background: #28a745; color: #fff; }
.btn-copy { background: #6f42c1; color: #fff; }
.btn-save { background: #007bff; color: #fff; }
.btn-update { background: #fd7e14; color: #fff; }
.btn-delete { background: #dc3545; color: #fff; }
.pagination {
  margin-top: 8px;
  display: flex;
  justify-content: center;
  gap: 6px;
  font-size: 11px;
}
.search-bar {
  margin-bottom: 8px;
  display: flex;
  gap: 6px;
  align-items: center;
  font-size: 11px;
}
.search-bar input,
.search-bar select {
  padding: 2px 4px;
  font-size: 11px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
.search-bar button {
  padding: 2px 6px;
  font-size: 11px;
  background: #dc3545;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.total-amount {
  margin-top: 10px;
  font-weight: bold;
  font-size: 12px;
  text-align: right;
}
</style>
